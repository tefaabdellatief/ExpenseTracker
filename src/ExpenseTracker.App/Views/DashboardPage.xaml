<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ExpenseTracker.App.Views.DashboardPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:chart="clr-namespace:Syncfusion.Maui.Charts;assembly=Syncfusion.Maui.Charts"
    xmlns:models="clr-namespace:ExpenseTracker.App.Models"
    xmlns:vm="clr-namespace:ExpenseTracker.App.ViewModels"
    Title="Dashboard"
    x:DataType="vm:DashboardViewModel">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">
            <!--  Summary Cards  -->
            <Grid
                ColumnDefinitions="*,*"
                ColumnSpacing="15"
                RowDefinitions="Auto,Auto"
                RowSpacing="15">
                <!--  Total Expenses Card  -->
                <Border
                    Grid.Row="0"
                    Grid.Column="0"
                    Padding="20"
                    BackgroundColor="{StaticResource Primary}"
                    StrokeShape="RoundRectangle 15">
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="24"
                            HorizontalOptions="Center"
                            Text="ðŸ’°" />
                        <Label
                            FontSize="12"
                            HorizontalOptions="Center"
                            Text="Total Expenses"
                            TextColor="{StaticResource Primary}" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="18"
                            HorizontalOptions="Center"
                            Text="{Binding TotalExpenses, StringFormat='{0:F2} EGP'}"
                            TextColor="{StaticResource Primary}" />
                    </VerticalStackLayout>
                </Border>
                <!--  Total Transactions Card  -->
                <Border
                    Grid.Row="0"
                    Grid.Column="1"
                    Padding="20"
                    BackgroundColor="{StaticResource Secondary}"
                    StrokeShape="RoundRectangle 15">
                    <VerticalStackLayout Spacing="8">
                        <Label
                            FontSize="24"
                            HorizontalOptions="Center"
                            Text="ðŸ“Š" />
                        <Label
                            FontSize="12"
                            HorizontalOptions="Center"
                            Text="Transactions"
                            TextColor="{StaticResource Primary}" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="18"
                            HorizontalOptions="Center"
                            Text="{Binding TotalTransactions}"
                            TextColor="{StaticResource Primary}" />
                    </VerticalStackLayout>
                </Border>
                <!--  Average Expense Card  -->
                <Border
                    Grid.Row="1"
                    Grid.Column="0"
                    Grid.ColumnSpan="2"
                    Padding="20"
                    BackgroundColor="{StaticResource Surface}"
                    StrokeShape="RoundRectangle 15">
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="15">
                        <Label
                            FontSize="24"
                            Text="ðŸ“ˆ"
                            VerticalOptions="Center" />
                        <VerticalStackLayout Spacing="4">
                            <Label
                                FontAttributes="Bold"
                                FontSize="14"
                                Text="Average per Transaction" />
                            <Label
                                FontSize="16"
                                Text="{Binding AverageExpense, StringFormat='{0:F2} EGP'}"
                                TextColor="{StaticResource Primary}" />
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                </Border>
            </Grid>
            <!--  Category Breakdown Section  -->
            <VerticalStackLayout Spacing="15">
                <Label
                    FontAttributes="Bold"
                    FontSize="20"
                    Text="Expenses by Category"
                    TextColor="{StaticResource Primary}" />
                <!--  Visual Chart Area  -->
                <Border
                    Padding="20"
                    BackgroundColor="{StaticResource Surface}"
                    StrokeShape="RoundRectangle 15">
                    <VerticalStackLayout Spacing="15">
                        <Label
                            FontAttributes="Bold"
                            FontSize="16"
                            HorizontalOptions="Center"
                            Text="Category Distribution" />
                        <!--  Debug: Show count  -->
                        <Label
                            FontSize="12"
                            HorizontalOptions="Center"
                            Text="{Binding CategoryData.Count, StringFormat='Categories: {0}'}"
                            TextColor="Red" />
                        <!--  percentages  -->
                        <CollectionView
                            x:Name="CategoryChart"
                            BackgroundColor="White"
                            HeightRequest="360"
                            HorizontalOptions="Center"
                            ItemsSource="{Binding CategoryData}">
                            <CollectionView.ItemsLayout>
                                <GridItemsLayout Orientation="Horizontal" Span="2" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:CategoryExpenseData">
                                    <Border
                                        Margin="5"
                                        Padding="10,6"
                                        BackgroundColor="{StaticResource Divider}"
                                        HorizontalOptions="Fill"
                                        WidthRequest="220">
                                        <VerticalStackLayout Spacing="5">
                                            <Label
                                                FontSize="24"
                                                HorizontalOptions="Center"
                                                Text="{Binding CategoryIcon}" />
                                            <Label
                                                FontAttributes="Bold"
                                                HorizontalOptions="Center"
                                                Text="{Binding Category}" />
                                            <Label HorizontalOptions="Center" Text="{Binding Amount, StringFormat='{0:F2} EGP'}" />
                                            <Label
                                                FontSize="20"
                                                HorizontalOptions="Center"
                                                Text="{Binding Percentage, StringFormat='{0:F1}%'}" />
                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>
                <!--  Empty State  -->
                <Border
                    x:Name="EmptyStateContainer"
                    Padding="40"
                    BackgroundColor="{StaticResource Surface}"
                    StrokeShape="RoundRectangle 15">
                    <VerticalStackLayout HorizontalOptions="Center" Spacing="10">
                        <Label
                            FontSize="48"
                            HorizontalOptions="Center"
                            Text="ðŸ“Š" />
                        <Label
                            FontAttributes="Bold"
                            FontSize="18"
                            HorizontalOptions="Center"
                            Text="No expenses yet" />
                        <Label
                            FontSize="14"
                            HorizontalOptions="Center"
                            HorizontalTextAlignment="Center"
                            Text="Start adding expenses to see your spending breakdown"
                            TextColor="{StaticResource Gray600}" />
                    </VerticalStackLayout>
                </Border>
                <!--  syncf charts  -->
                <chart:SfCartesianChart>
                    <!--<chart:SfCartesianChart.Legend>
                        <chart:ChartLegend />
                    </chart:SfCartesianChart.Legend>-->
                    <chart:SfCartesianChart.Title>
                        <Label
                            Margin="0,12"
                            HorizontalOptions="Center"
                            Text="Expense category Comparison" />
                    </chart:SfCartesianChart.Title>
                    <chart:SfCartesianChart.XAxes>
                        <chart:CategoryAxis>
                            <chart:CategoryAxis.Title>
                                <chart:ChartAxisTitle Text="Category" />
                            </chart:CategoryAxis.Title>
                        </chart:CategoryAxis>
                    </chart:SfCartesianChart.XAxes>
                    <chart:SfCartesianChart.YAxes>
                        <chart:NumericalAxis>
                            <chart:NumericalAxis.Title>
                                <chart:ChartAxisTitle Text="Expense(in egp)" />
                            </chart:NumericalAxis.Title>
                        </chart:NumericalAxis>
                    </chart:SfCartesianChart.YAxes>
                    <chart:ColumnSeries
                        EnableTooltip="True"
                        ItemsSource="{Binding CategoryData}"
                        ShowDataLabels="True"
                        XBindingPath="DisplayText"
                        YBindingPath="Amount" />
                </chart:SfCartesianChart>
            </VerticalStackLayout>
            <!--  Loading Indicator  -->
            <ActivityIndicator
                HeightRequest="40"
                IsRunning="{Binding IsBusy}"
                IsVisible="{Binding IsBusy}"
                Color="{StaticResource Primary}" />
            <!--  export button  -->
            <Button
                BackgroundColor="{StaticResource Accent2}"
                Command="{Binding ExportExpensesCommand}"
                CornerRadius="12"
                FontAttributes="Bold"
                HeightRequest="55"
                Text="Export your expenses" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
